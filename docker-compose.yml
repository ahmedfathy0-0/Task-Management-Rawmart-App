version: "3.8"
services:
  app:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: laravel-app
    container_name: laravel-app
    restart: unless-stopped
    working_dir: /var/www
    environment:
      DB_CONNECTION: sqlite
      DB_DATABASE: /var/www/database/database.sqlite
    volumes:
      - ./backend:/var/www:z
    networks:
      - app-network

  # Frontend (Nginx + React + API Proxy)
  # Using the production config (nginx.prod.conf) allows us to test the
  # single-port setup locally if we build with the prod context,
  # but here we use the dev context typically.
  # However, for consistency with deployment, we can keep the separate webserver service
  # or merge them. The user asked for "deployment in one server".
  # Providing a dev setup that mimics prod is good.

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: react-frontend
    container_name: react-frontend
    ports:
      - "5173:80"
    networks:
      - app-network
    depends_on:
      - app

  # Webserver for Backend (Nginx) - Standard Laravel Setup
  # We still need this because PHP-FPM doesn't speak HTTP.
  # The frontend container proxies /api to this 'webserver' container?
  # NO, frontend proxies to 'app:9000' (PHP-FPM) directly via FastCGI?
  # My previous nginx.prod.conf used `proxy_pass http://app:9000;`.
  # Nginx `proxy_pass` usually expects HTTP. PHP-FPM speaks FastCGI.
  # If frontend Nginx proxies to app:9000, it needs `fastcgi_pass` NOT `proxy_pass`.
  # LET'S FIX THIS in nginx.prod.conf later.
  # For now, let's keep the backend webserver so we can access it directly if needed,
  # OR we fix the frontend proxy to use fastcgi.
  # Actually, simpler model: Frontend Nginx is THE webserver.
  # It serves static files AND routes /api to PHP-FPM.
  # So we DO NOT NEED a separate backend webserver container if frontend does it.
  # Let's remove 'webserver' service and update frontend nginx config to act as the unified server.

networks:
  app-network:
    driver: bridge
